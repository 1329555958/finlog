/*! finlog - v0.2.0 - 2017-03-09 Copyright (c) 2017 vfinance; Licensed MIT */
require("app").register.controller("TraceController",function($scope,$myhttp,$timeout,$location,$rootScope){function searchParam(name,val){return void 0==val?$location.search()[name]:void $location.search(name,val)}function getSpans(hits){var spans=_.map(hits,function(hit){return hit._source});return spans}function addChildren(parents,spans){0!==spans.length&&_.each(parents,function(parent){var children=_.remove(spans,function(child){return child.traceId===parent.traceId&&isChildId(child.id,parent.id)});children.length&&(parent.nodes=children,addChildren(children,spans))})}function isChildId(cid,pid){return cid.substring(0,cid.lastIndexOf("."))===pid}function getRootNodes(spans){return _.remove(spans,function(span){return"1"===span.id})}function addNodeText(spans){_.each(spans,function(span){span.text=makeNodeText(span)})}function makeNodeText(span){var text=[];return span.className&&(text.push(span.className.substring(span.className.lastIndexOf(".")+1)),text.push(".")),text.push(span.methodName),text.join("")}function makeTree(data){var spans=getSpans(data);addNodeText(spans);var roots=getRootNodes(spans);addChildren(roots,spans);for(var tree=[],i=0;i<roots.length;i++){for(var result={success:!1},node=roots[i],j=0;j<roots.length&&(i===j||(mergeTree(roots[j],node,result),!result.success));j++);result.success||tree.push(node)}return!tree.length&&$scope.hits.length&&console.error("数据异常!",$scope.hits),tree}function mergeTree(pTree,tree,result){null!=pTree&&(pTree.extId===tree.traceId&&(_.extend(pTree,tree),result.success=!0),pTree.nodes&&_.each(pTree.nodes,function(node){mergeTree(node,tree,result)}))}function initTree(data){if($("#tree").treeview({data:data}),null!==data&&data.length){$("#tree").on("nodeSelected",onNodeSelected),$("#tree").treeview("selectNode",[0,{silent:!0}]);var node=$("#tree").treeview("getNode",0);onNodeSelected(null,node)}}function onNodeSelected(event,data){$scope.span=data,$scope.$digest()}$scope.span={},$scope.chainId=searchParam("chainId"),$scope.search=function(){if(!$scope.chainId)return void alert("请输入追踪链编号!");var param={chain:$scope.chainId};searchParam("chainId",$scope.chainId),$scope.searching=!0,$myhttp("searching",$scope).get("/trace/qry",param,function(data){$scope.hits=data,initTree(makeTree(data.hits))})},function(){$scope.chainId&&$scope.search()}()});