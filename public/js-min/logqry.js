/*! finlog - v0.2.0 - 2017-03-09 Copyright (c) 2017 vfinance; Licensed MIT */
require("app").register.controller("logqryTabController",function($scope,$myhttp,$timeout,$location,$rootScope){function loadSelectDataByField(filedName){var endTime=(new Date).getTime(),startTime=endTime-864e5;$myhttp.get("/dashboard/countByField",{type:filedName,startTime:startTime,endTime:endTime},function(response){response.success!==!1&&(SelectData[filedName]=transferSelectData(response))},"JSON")}function transferSelectData(list){return _.map(list,function(l){return{id:l.x,text:l.x}})}function filterSelectItem(list,text){var result=_.filter(list,function(l){return-1!==l.text.indexOf(text)});return 0===result.length&&result.push({id:text,text:text}),result}function makeSelect(fieldName){selectDom(fieldName).select2({placeholder:"请选择或者输入",minimumInputLength:1,query:function(query){var data={results:SelectData[fieldName]||[]};query.term&&data.results&&(data.results=filterSelectItem(data.results,query.term)),query.callback(data)},initSelection:function(element,callback){var data={id:element.val(),text:element.val()};callback(data)}}).on("select2-close",function(){var field=$scope.currentSelectFiled;$scope.condition[field]=selectVal(field)}).on("select2-blur",function(){$scope.currentSelectFiled="",$scope.$digest()})}function selectVal(fieldName,val){return val?void selectDom(fieldName).select2("val",val):selectDom(fieldName).select2("val")}function selectDom(fieldName){return $("#"+fieldName+$scope.ID_SUFFIX)}function reset(){$scope.condition={},$scope.addedConds=[],$scope.hasCond=!0}function saveConfigData(data){data&&_.extend(configData,data),configData.id&&$scope.$emit("ToSaveConfig",configData)}function removeMark(str){return str?str.replace(/<\/?mark>/g,""):str}function getSourceData(rcd){var result=[];return _.each(rcd,function(val,key){result.push('<span class="field-key">'+key+":</span>"+JSON.stringify(val).replace(/\\"/g,""))}),result.join(" ")}var selectFileds=$scope.selectFileds=["envInfo","appName","filePath"],SelectData={};$scope.ID_SUFFIX=_.uniqueId("_"),_.each(selectFileds,loadSelectDataByField),$scope.currentSelectFiled="",$scope.isSelectField=function(field){return _.contains($scope.selectFileds,field)},$scope.showSelect=function(field){$scope.isSelectField(field)&&(makeSelect(field),void 0!==$scope.condition[field]&&selectVal(field,$scope.condition[field]),$scope.currentSelectFiled=field)};var TabId=null;$(".tab-pane>.ng-scope").each(function(){var s=angular.element(this).scope();s.$id===$scope.$id&&(TabId=$(this).parent(".tab-pane").attr("id"))});var loadCfgDef=$.Deferred(),timeRangeDef=$.Deferred(),configData={id:"",condition:{},showFields:[]};$scope.conditonChangeToSearch=!1,$scope.maxLengthField="",$scope.fieldSet=[],$scope.hits={hits:[],aggs:[]};var def_show_field=[],allFields=[];reset();var eventName="OnReceive"+TabId;$scope.$on(eventName,function(event,data){configData.id||(_.extend(configData,data),$scope.condition=configData.condition||{},$scope.addedConds=_.keys($scope.condition),configData.sort&&configData.sort.field||(configData.sort={field:"@timestamp",type:"desc"}),$scope.sort=configData.sort),loadCfgDef.resolve()}),$scope.$emit("ConsumeAConfig",{tabId:TabId,eventName:eventName});var IsShownTab=$("#"+TabId).hasClass("active");$scope.$on(EVENT.TAB_SHOWN.broadcast,function(event,data){0===data.target.target.indexOf("#")&&(data.target.target==="#"+TabId?(IsShownTab=!0,$location.search("tabId",TabId),$scope.search()):IsShownTab=!1)}),$.when($myhttp.get("/logqry/fields",function(data){$scope.fieldSet=data.allFields,allFields=data.allFields,$scope.addCondition(),configData.allFields=$scope.fieldSet,def_show_field=_.filter(data.showFields,function(f){return"message"!==f}),$scope.maxLengthField=_.max($scope.fieldSet,function(f){return f.length})+"NN"})),$scope.addCondition=function(){var reminder_conds=$scope.getReminderFields();$scope.hasCond&&$scope.addedConds.push(reminder_conds[0])},$scope.removeCond=function(index){var cond=$scope.addedConds.splice(index,1);$scope.condition[cond[0]]&&$scope.search(null,null,!0),delete $scope.condition[cond[0]]},$scope.getReminderFields=function(field){var fields=[];field&&fields.push(field);var reminder_conds=_.difference($scope.fieldSet,$scope.addedConds);return $scope.hasCond=!!reminder_conds.length,fields.concat(reminder_conds)},$scope.search=function(append,size,mask){if(IsShownTab){append=void 0===append?!1:append;var fields={};_.each($scope.addedConds,function(f){fields[f]={a:1}});var param={body:{highlight:{require_field_match:"true",pre_tags:["<mark>"],post_tags:["</mark>"],fields:fields}},size:angular.isNumber(size)?size:30},condition=configData.condition;append?param.from=$scope.hits.hits.length:(param.countType=_timeslot.unit,condition=_.pick($scope.condition,$scope.addedConds),_.each($scope.fieldSet,function(f){"message"!==f&&condition[f]&&(condition[f]=condition[f].toLowerCase())}),saveConfigData({condition:condition,sort:$scope.sort})),param.condition=condition,_.extend(param,APP.getCurrentTimeRange(_timeslot)),param.sort=$scope.sort.field+("@timestamp"!==$scope.sort.field?".raw":"")+":"+$scope.sort.type,$scope.searching=mask||!append||!!size||!$scope.hits.hits,$scope.hasMoreHits=!0,append||($scope.hits=[]),$myhttp("searching",$scope).get("/logQry/qry",param,function(data){data.hits&&_.each(data.hits,function(hit){hit._source.message=hit._source.message.replace(/<(\w+)/g,"< $1").replace(/(\w+)>/g,"$1 >")}),append?($scope.hits.total=data.total,$scope.hits.hits=$scope.hits.hits.concat(_.replaceHighlightField(data.hits))):($scope.hits=data,$scope.hits.hits=_.replaceHighlightField(data.hits)),(!$scope.hits||data.total<=$scope.hits.hits.length)&&($scope.hasMoreHits=!1)})}},$scope.changeSort=function(field){"message"!==field&&($scope.sort.field===field?$scope.sort.type="desc"===$scope.sort.type?"asc":"desc":($scope.sort.field=field,$scope.sort.type="desc"),$scope.search(!1,_.get($scope,"hits.hits.length",30)))},$scope.getSortClass=function(field){return"message"!==field?$scope.sort.field===field?"sorting_"+$scope.sort.type:"sorting":""},$scope.reset=function(){reset(),$scope.addCondition()};var delaySearchQueue=[];$scope.delaySearch=function(){if($scope.conditonChangeToSearch){for(var i=0;i<delaySearchQueue.length;i++)$timeout.cancel(delaySearchQueue.shift());delaySearchQueue.push($timeout(function(){$scope.search(null,null,!0)},700))}},$scope.getShowFields=function(){return configData.showFields.length||(configData.showFields=[].concat(def_show_field)),configData.showFields},$scope.getHidenFields=function(){return _.difference(allFields,configData.showFields)},$scope.addShowField=function(field){configData.showFields.push(field),saveConfigData()},$scope.removeShowField=function(field){var index=_.indexOf(configData.showFields,field);-1!==index&&(configData.showFields.splice(index,1),saveConfigData())},$scope.showAsFileText=function(){$scope.$emit("showAsFileText",$scope.hits)},$scope.showInFileUrl=function(rcd){var param={};param.hostName=removeMark(rcd._source.hostName),param.filePath=removeMark(rcd._source.filePath),param.envInfo=removeMark(rcd._source.envInfo),param.appName=removeMark(rcd._source.appName),param.id=removeMark(rcd._id);var date=dateUtil.parse(rcd._source["@timestamp"])||new Date,timestamp=date.getTime();param.startTime=timestamp-5e3,param.endTime=timestamp+5e3;var url="/fileview?"+$.param(param);return url},$scope.showRecordDetail={};var _timeslot=null;$scope.getFieldData=function(field,rcd){return"_source"===field?getSourceData(rcd):rcd._source[field]},$scope.getShowData=function(rcd){return _.omit(rcd,"showjson","$$hashKey")},$scope.aceJson=function(obj){return JSON.stringify(obj,function(key,value){return value},"	").replace(/<(\/)?mark>/g,"")},$scope.$on(EVENT.CONDITION_CHANGE.broadcast,function(event,data){"pending"!==timeRangeDef.state()&&$scope.search()}),$scope.$on(TabId,function(event,data){_timeslot=data,_timeslot.value=_timeslot.timeSlot,timeRangeDef.resolve()}),$scope.$on(EVENT.SCROLL_BOTTOM.broadcast,function(event,data){$scope.search(!0)}),$scope.$emit(EVENT.CHANGE_CONDITION.emit,TabId),$.when(loadCfgDef,timeRangeDef).then($scope.search)}),require("app").register.controller("logqryController",function($rootScope,$scope,$myhttp,$location){function saveConfig(data){var old=_.find($scope.tabConfig.tabs,function(t){return t.id===data.id});old&&(_.extend(old,data),_.each(old,function(val,key){_.startsWith(key,"$$")&&delete old[key]}),$myhttp.post("/logqry/savecfg",JSON.stringify(old),function(data){console.info(data)}))}function loadConfig(){$myhttp.get("/logQry/loadQry",function(data){$scope.tabConfig.tabs=[],_.each(data,function(cfg){$scope.tabConfig.addTab(cfg,cfg.id!==params.tabId)})})}function saveCallback(tab){saveConfig(tab)}function addCallback(tab){UnbindTabIds.push(tab.id),saveConfig(tab)}function closeCallback(tab){_.remove($scope.tabConfig.tabs,function(t){return t.id===tab.id})}function delCallback(tab){$myhttp.post("/logQry/delQry",JSON.stringify({id:tab.id}),function(data){console.log("删除查询",tab,data)})}var params=$location.search()||{};$scope.tabPage="/public/views/logqry_sub.html",$scope.tabConfig={newTabName:"新建查询",tabs:[],templateUrl:$scope.tabPage,saveCallback:saveCallback,addCallback:addCallback,closeCallback:closeCallback,delCallback:delCallback};var UnbindTabIds=[];$scope.$on("ToSaveConfig",function(event,data){saveConfig(data)}),$scope.$on("ConsumeAConfig",function(event,data){var tabid=data.tabId,cfg=null;tabid&&_.remove(UnbindTabIds,function(id){return id===tabid}).length&&(cfg=_.find($scope.tabConfig.tabs,function(t){return t.id===tabid}),cfg=cfg?_.omit(cfg,"name","oldName"):null),$scope.$broadcast(data.eventName,cfg)}),$scope.fullScreen=function(data){$scope.hits=data;var $fullDlg=$("#fullScreenDlg");$fullDlg.show()},$scope.hideRecordContext=function(){var $fullDlg=$("#fullScreenDlg");$fullDlg.hide()},$scope.$on("showAsFileText",function(event,hits){$scope.fullScreen(hits)}),loadConfig()});