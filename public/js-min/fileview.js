/*! finlog - v0.2.0 - 2017-03-09 Copyright (c) 2017 vfinance; Licensed MIT */
require("app").register.controller("FileviewController",function($scope,$timeout,$location,$myhttp){function loadSelectDataByField(filedName){var endTime=(new Date).getTime(),startTime=endTime-864e5;$myhttp.get("/dashboard/countByField",{type:filedName,startTime:startTime,endTime:endTime},function(response){response.success!==!1&&(SelectData[filedName]=transferSelectData(response))},"JSON")}function transferSelectData(list){return _.map(list,function(l){return{id:l.x,text:l.x}})}function filterSelectItem(list,text){var result=_.filter(list,function(l){return-1!==l.text.indexOf(text)});return 0===result.length&&result.push({id:text,text:text}),result}function makeSelect(fieldName){$("#"+fieldName).select2({placeholder:"请选择或者输入",minimumInputLength:1,query:function(query){var data={results:SelectData[fieldName]||[]};query.term&&data.results&&(data.results=filterSelectItem(data.results,query.term)),query.callback(data)},initSelection:function(element,callback){var data={id:element.val(),text:element.val()};callback(data)}})}function selectVal(fieldName,val){return val?void $("#"+fieldName).select2("val",val):$("#"+fieldName).select2("val")}function validate(){return!_.find(selectFileds,function(field){return!selectVal(field)})}function parseDate(date){var now=dateUtil.parse(date)||new Date;return now.getTime()}var selectFileds=["envInfo","appName","filePath"],searchParam=$location.search();$scope.startDate=searchParam.startTime?new Date(searchParam.startTime-0):new Date,$scope.endDate=searchParam.endTime?new Date(searchParam.endTime-0):new Date,$scope.selectedId=searchParam.id;var SelectData={};_.each(selectFileds,loadSelectDataByField),_.each(selectFileds,makeSelect),_.each(selectFileds,function(field){selectVal(field,searchParam[field])}),$scope.search=function(append,size,mask,isScrollTrigger){if(!validate()){if(isScrollTrigger)return;alert("请输入必填参数!")}var param={body:{highlight:{require_field_match:"true",pre_tags:["<mark>"],post_tags:["</mark>"],fields:{message:{a:1}}}},size:angular.isNumber(size)?size:30},condition={filePath:selectVal("filePath"),message:$scope.message,envInfo:selectVal("envInfo"),appName:selectVal("appName")};append=void 0===append?!1:append,append&&(param.from=$scope.hits.hits.length),param.startTime=parseDate($scope.startDate),param.endTime=parseDate($scope.endDate),param.condition=condition,param.sort="@timestamp:asc",$scope.searching=mask||!append||!!size||!$scope.hits.hits,$scope.hasMoreHits=!0,append||($scope.hits=[]),$myhttp("searching",$scope).get("/logQry/qry",param,function(data){var hits=[];data.hits&&(_.each(data.hits,function(hit){hit._source.message=hit._source.message.replace(/<(\w+)/g,"< $1").replace(/(\w+)>/g,"$1 >")}),_.each(_.replaceHighlightField(data.hits),function(hit){hits.push({message:hit._source.message,id:hit._id})}),data.hits=hits),append?($scope.hits.total=data.total,$scope.hits.hits=$scope.hits.hits.concat(data.hits)):($scope.hits=data,$scope.hits.hits=data.hits),(!$scope.hits||data.total<=$scope.hits.hits.length)&&($scope.hasMoreHits=!1)})},validate()&&$scope.search(),$scope.$on(EVENT.SCROLL_BOTTOM.broadcast,function(event,data){$scope.search(!0,void 0,void 0,!0)}),$("html, body").animate({scrollTop:0},"slow")});